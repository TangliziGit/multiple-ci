#!/bin/env bash

here="$(dirname "$0")"

prepare() {
  cd "$here/.." || exit 0
  python -m venv venv

  docker run --name redis \
   -p 6379:6379 -d redis

  docker run --name rabbitmq \
    -p 5672:5672 -p 15672:15672 --hostname rabbitmq \
    -e RABBITMQ_DEFAULT_USER=root -e RABBITMQ_DEFAULT_PASS=123456 -d rabbitmq:3-management

  docker run --name es \
    -p 9200:9200 -p 9300:9300 -e "discovery.type=single-node" \
    -e ES_JAVA_OPTS="-Xms256m -Xmx256m" -e "xpack.security.enabled=false" \
    -e "xpack.security.http.ssl.enabled=false" -d elasticsearch:8.5.3
}

install() {
  source "$here/../venv/bin/activate"
  pip install -e "$here/.."
}

start() {
  docker start redis
  docker start rabbitmq
  docker start es
}


case $1 in
prepare)
  prepare;;
install)
  install;;
start)
  start;;
esac