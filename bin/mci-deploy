#!/bin/env bash

here="$(dirname "$0")"

prepare() {
  cd "$here/.." || exit 0
  python -m venv venv

  docker run --name redis \
   -p 6379:6379 -d redis

  docker run --name rabbitmq \
    -p 5672:5672 -p 15672:15672 --hostname rabbitmq \
    -e RABBITMQ_DEFAULT_USER=root -e RABBITMQ_DEFAULT_PASS=123456 -d rabbitmq:3-management

  docker run --name es \
    -p 9200:9200 -p 9300:9300 -e "discovery.type=single-node" -d elasticsearch:8.5.3

  docker run --name etcd \
    -d -p 2379:2379 -p 2380:2380 \
    quay.io/coreos/etcd:latest /usr/local/bin/etcd \
    --name s1 --data-dir /etcd-data \
    --listen-client-urls http://0.0.0.0:2379 \
    --advertise-client-urls http://0.0.0.0:2379 \
    --listen-peer-urls http://0.0.0.0:2380 \
    --initial-advertise-peer-urls http://0.0.0.0:2380 \
    --initial-cluster s1=http://0.0.0.0:2380 \
    --initial-cluster-token tkn \
    --initial-cluster-state new
}

install() {
  source "$here/../venv/bin/activate"
  pip install -e "$here/.."
}

start() {
  docker start redis
  docker start rabbitmq
  docker start es
  docker start etcd
}


case $1 in
prepare)
  prepare;;
install)
  install;;
start)
  start;;
esac